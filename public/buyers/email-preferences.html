<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Email Preferences - Velocity Real Estate</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 40px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      margin-bottom: 20px;
    }

    .card-header {
      margin-bottom: 30px;
    }

    .card-title {
      font-size: 28px;
      font-weight: 700;
      color: #1E293B;
      margin-bottom: 8px;
    }

    .card-subtitle {
      font-size: 16px;
      color: #64748B;
    }

    .preference-section {
      margin-bottom: 32px;
      padding-bottom: 32px;
      border-bottom: 1px solid #E2E8F0;
    }

    .preference-section:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }

    .section-title {
      font-size: 20px;
      font-weight: 600;
      color: #1E293B;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .section-description {
      font-size: 14px;
      color: #64748B;
      margin-bottom: 20px;
    }

    .preference-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      background: #F8FAFC;
      border-radius: 8px;
      margin-bottom: 12px;
      transition: background 0.2s ease;
    }

    .preference-item:hover {
      background: #F1F5F9;
    }

    .preference-info {
      flex: 1;
    }

    .preference-label {
      font-weight: 600;
      color: #1E293B;
      margin-bottom: 4px;
    }

    .preference-description {
      font-size: 14px;
      color: #64748B;
    }

    /* Toggle Switch */
    .toggle-switch {
      position: relative;
      width: 56px;
      height: 28px;
      background: #CBD5E1;
      border-radius: 14px;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .toggle-switch.active {
      background: #10B981;
    }

    .toggle-switch::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 24px;
      height: 24px;
      background: white;
      border-radius: 50%;
      transition: transform 0.3s ease;
    }

    .toggle-switch.active::after {
      transform: translateX(28px);
    }

    /* Quiet Hours */
    .time-inputs {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-top: 16px;
    }

    .time-input-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .time-input-label {
      font-size: 14px;
      font-weight: 600;
      color: #475569;
    }

    .time-input {
      padding: 12px;
      border: 2px solid #E2E8F0;
      border-radius: 8px;
      font-size: 16px;
    }

    .time-input:focus {
      outline: none;
      border-color: #F59E0B;
    }

    .time-input:disabled {
      background: #F1F5F9;
      cursor: not-allowed;
    }

    /* Save Button */
    .btn-save {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, #F59E0B 0%, #F97316 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .btn-save:hover {
      transform: translateY(-2px);
    }

    .btn-save:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    /* Success Message */
    .success-message {
      padding: 16px;
      background: #D1FAE5;
      color: #059669;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
      align-items: center;
      gap: 8px;
      font-weight: 600;
    }

    .success-message.show {
      display: flex;
    }

    /* Unsubscribe Warning */
    .unsubscribe-warning {
      padding: 16px;
      background: #FEE2E2;
      color: #DC2626;
      border-radius: 8px;
      margin-top: 16px;
      font-size: 14px;
    }

    @media (max-width: 768px) {
      .card {
        padding: 24px;
      }

      .time-inputs {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>

  <div class="container">
    <!-- Success Message -->
    <div class="success-message" id="success-message">
      ‚úÖ Preferences saved successfully!
    </div>

    <div class="card">
      <div class="card-header">
        <div class="card-title">üìß Email Preferences</div>
        <div class="card-subtitle">Manage how you receive notifications from Velocity Real Estate</div>
      </div>

      <form id="preferences-form" onsubmit="savePreferences(event)">

        <!-- Email Notifications -->
        <div class="preference-section">
          <div class="section-title">
            üì¨ Email Notifications
          </div>
          <div class="section-description">
            Choose which emails you want to receive
          </div>

          <div class="preference-item">
            <div class="preference-info">
              <div class="preference-label">New Deals</div>
              <div class="preference-description">Get notified when deals match your criteria</div>
            </div>
            <div class="toggle-switch" id="toggle-newDeals" onclick="toggleSwitch('newDeals')"></div>
          </div>

          <div class="preference-item">
            <div class="preference-info">
              <div class="preference-label">Daily Digest</div>
              <div class="preference-description">Daily summary of new deals at 8am</div>
            </div>
            <div class="toggle-switch" id="toggle-dailyDigest" onclick="toggleSwitch('dailyDigest')"></div>
          </div>

          <div class="preference-item">
            <div class="preference-info">
              <div class="preference-label">Weekly Report</div>
              <div class="preference-description">Market trends and insights every Monday</div>
            </div>
            <div class="toggle-switch" id="toggle-weeklyReport" onclick="toggleSwitch('weeklyReport')"></div>
          </div>

          <div class="preference-item">
            <div class="preference-info">
              <div class="preference-label">Bid Updates</div>
              <div class="preference-description">When your bid status changes</div>
            </div>
            <div class="toggle-switch active" id="toggle-bidUpdates" onclick="toggleSwitch('bidUpdates')"></div>
          </div>

          <div class="preference-item">
            <div class="preference-info">
              <div class="preference-label">Outbid Alerts</div>
              <div class="preference-description">When someone bids higher than you</div>
            </div>
            <div class="toggle-switch active" id="toggle-outbid" onclick="toggleSwitch('outbid')"></div>
          </div>

          <div class="preference-item">
            <div class="preference-info">
              <div class="preference-label">Deal Closed</div>
              <div class="preference-description">When your deal closes successfully</div>
            </div>
            <div class="toggle-switch active" id="toggle-dealClosed" onclick="toggleSwitch('dealClosed')"></div>
          </div>
        </div>

        <!-- SMS Notifications -->
        <div class="preference-section">
          <div class="section-title">
            üì± SMS Notifications
          </div>
          <div class="section-description">
            Get text messages for time-sensitive alerts (standard rates apply)
          </div>

          <div class="preference-item">
            <div class="preference-info">
              <div class="preference-label">Enable SMS</div>
              <div class="preference-description">Turn on/off all SMS notifications</div>
            </div>
            <div class="toggle-switch" id="toggle-smsEnabled" onclick="toggleSwitch('smsEnabled')"></div>
          </div>

          <div class="preference-item" id="sms-newDeals-item">
            <div class="preference-info">
              <div class="preference-label">New Hot Deals</div>
              <div class="preference-description">SMS for exceptional matches (80%+)</div>
            </div>
            <div class="toggle-switch" id="toggle-smsNewDeals" onclick="toggleSwitch('smsNewDeals')"></div>
          </div>

          <div class="preference-item" id="sms-bidUpdates-item">
            <div class="preference-info">
              <div class="preference-label">Bid Updates</div>
              <div class="preference-description">SMS when bid status changes</div>
            </div>
            <div class="toggle-switch" id="toggle-smsBidUpdates" onclick="toggleSwitch('smsBidUpdates')"></div>
          </div>

          <div class="preference-item" id="sms-urgentOnly-item">
            <div class="preference-info">
              <div class="preference-label">Urgent Only</div>
              <div class="preference-description">Only critical/time-sensitive SMS</div>
            </div>
            <div class="toggle-switch" id="toggle-smsUrgentOnly" onclick="toggleSwitch('smsUrgentOnly')"></div>
          </div>
        </div>

        <!-- Quiet Hours -->
        <div class="preference-section">
          <div class="section-title">
            üåô Quiet Hours
          </div>
          <div class="section-description">
            Don't send me notifications during these hours (we'll queue them for later)
          </div>

          <div class="preference-item">
            <div class="preference-info">
              <div class="preference-label">Enable Quiet Hours</div>
              <div class="preference-description">Pause notifications at night</div>
            </div>
            <div class="toggle-switch" id="toggle-quietHours" onclick="toggleSwitch('quietHours')"></div>
          </div>

          <div class="time-inputs" id="quiet-hours-times">
            <div class="time-input-group">
              <label class="time-input-label">Start Time</label>
              <input type="time" class="time-input" id="quiet-start" value="22:00" disabled />
            </div>
            <div class="time-input-group">
              <label class="time-input-label">End Time</label>
              <input type="time" class="time-input" id="quiet-end" value="08:00" disabled />
            </div>
          </div>
        </div>

        <!-- Marketing -->
        <div class="preference-section">
          <div class="section-title">
            üéØ Marketing & Updates
          </div>
          <div class="section-description">
            Occasional emails about new features, tips, and Velocity updates
          </div>

          <div class="preference-item">
            <div class="preference-info">
              <div class="preference-label">Product Updates</div>
              <div class="preference-description">New features and improvements</div>
            </div>
            <div class="toggle-switch active" id="toggle-productUpdates" onclick="toggleSwitch('productUpdates')"></div>
          </div>

          <div class="preference-item">
            <div class="preference-info">
              <div class="preference-label">Investment Tips</div>
              <div class="preference-description">Weekly tips for better deal analysis</div>
            </div>
            <div class="toggle-switch active" id="toggle-investmentTips" onclick="toggleSwitch('investmentTips')"></div>
          </div>

          <div class="preference-item">
            <div class="preference-info">
              <div class="preference-label">Market Insights</div>
              <div class="preference-description">Winnipeg market trends and analysis</div>
            </div>
            <div class="toggle-switch active" id="toggle-marketInsights" onclick="toggleSwitch('marketInsights')"></div>
          </div>
        </div>

        <!-- Unsubscribe All -->
        <div class="preference-section">
          <div class="section-title">
            üîï Unsubscribe All
          </div>

          <div class="preference-item">
            <div class="preference-info">
              <div class="preference-label">Unsubscribe from All Emails</div>
              <div class="preference-description">You'll only receive critical account emails</div>
            </div>
            <div class="toggle-switch" id="toggle-unsubscribeAll" onclick="toggleSwitch('unsubscribeAll')"></div>
          </div>

          <div class="unsubscribe-warning" id="unsubscribe-warning" style="display: none;">
            ‚ö†Ô∏è <strong>Warning:</strong> You won't receive deal alerts, bid updates, or any marketing emails. You'll miss out on new investment opportunities!
          </div>
        </div>

        <button type="submit" class="btn-save" id="save-btn">Save Preferences</button>
      </form>
    </div>
  </div>

  <script>
    let preferences = {
      email: {
        newDeals: false,
        dailyDigest: false,
        weeklyReport: false,
        bidUpdates: true,
        outbid: true,
        dealClosed: true
      },
      sms: {
        enabled: false,
        newDeals: false,
        bidUpdates: false,
        urgentOnly: false
      },
      quietHours: {
        enabled: false,
        startTime: '22:00',
        endTime: '08:00'
      },
      marketing: {
        productUpdates: true,
        investmentTips: true,
        marketInsights: true
      },
      unsubscribeAll: false
    };

    // Load preferences on page load
    window.addEventListener('DOMContentLoaded', () => {
      loadPreferences();
    });

    /**
     * LOAD PREFERENCES FROM SERVER
     */
    async function loadPreferences() {
      try {
        const response = await fetch('/api/user/preferences', {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
          }
        });

        if (response.ok) {
          const data = await response.json();
          preferences = data.notifications || preferences;
          renderPreferences();
        }
      } catch (error) {
        console.error('Failed to load preferences:', error);
        renderPreferences(); // Render defaults
      }
    }

    /**
     * RENDER PREFERENCES TO UI
     */
    function renderPreferences() {
      // Email
      setToggleState('newDeals', preferences.email.newDeals);
      setToggleState('dailyDigest', preferences.email.dailyDigest);
      setToggleState('weeklyReport', preferences.email.weeklyReport);
      setToggleState('bidUpdates', preferences.email.bidUpdates);
      setToggleState('outbid', preferences.email.outbid);
      setToggleState('dealClosed', preferences.email.dealClosed);

      // SMS
      setToggleState('smsEnabled', preferences.sms.enabled);
      setToggleState('smsNewDeals', preferences.sms.newDeals);
      setToggleState('smsBidUpdates', preferences.sms.bidUpdates);
      setToggleState('smsUrgentOnly', preferences.sms.urgentOnly);
      updateSMSItems();

      // Quiet Hours
      setToggleState('quietHours', preferences.quietHours.enabled);
      document.getElementById('quiet-start').value = preferences.quietHours.startTime;
      document.getElementById('quiet-end').value = preferences.quietHours.endTime;
      updateQuietHoursInputs();

      // Marketing
      setToggleState('productUpdates', preferences.marketing.productUpdates);
      setToggleState('investmentTips', preferences.marketing.investmentTips);
      setToggleState('marketInsights', preferences.marketing.marketInsights);

      // Unsubscribe
      setToggleState('unsubscribeAll', preferences.unsubscribeAll);
      updateUnsubscribeWarning();
    }

    /**
     * TOGGLE SWITCH
     */
    function toggleSwitch(key) {
      const element = document.getElementById(`toggle-${key}`);
      const isActive = element.classList.contains('active');

      if (key.startsWith('sms') && key !== 'smsEnabled') {
        preferences.sms[key.replace('sms', '').charAt(0).toLowerCase() + key.replace('sms', '').slice(1)] = !isActive;
      } else if (key === 'smsEnabled') {
        preferences.sms.enabled = !isActive;
        updateSMSItems();
      } else if (key === 'quietHours') {
        preferences.quietHours.enabled = !isActive;
        updateQuietHoursInputs();
      } else if (['productUpdates', 'investmentTips', 'marketInsights'].includes(key)) {
        preferences.marketing[key] = !isActive;
      } else if (key === 'unsubscribeAll') {
        preferences.unsubscribeAll = !isActive;
        updateUnsubscribeWarning();
      } else {
        preferences.email[key] = !isActive;
      }

      element.classList.toggle('active');
    }

    /**
     * SET TOGGLE STATE
     */
    function setToggleState(key, active) {
      const element = document.getElementById(`toggle-${key}`);
      if (active) {
        element.classList.add('active');
      } else {
        element.classList.remove('active');
      }
    }

    /**
     * UPDATE SMS ITEMS (disable if SMS not enabled)
     */
    function updateSMSItems() {
      const smsEnabled = preferences.sms.enabled;
      const opacity = smsEnabled ? '1' : '0.5';
      const pointerEvents = smsEnabled ? 'auto' : 'none';

      ['sms-newDeals-item', 'sms-bidUpdates-item', 'sms-urgentOnly-item'].forEach(id => {
        const element = document.getElementById(id);
        element.style.opacity = opacity;
        element.style.pointerEvents = pointerEvents;
      });
    }

    /**
     * UPDATE QUIET HOURS INPUTS (enable/disable)
     */
    function updateQuietHoursInputs() {
      const enabled = preferences.quietHours.enabled;
      document.getElementById('quiet-start').disabled = !enabled;
      document.getElementById('quiet-end').disabled = !enabled;
    }

    /**
     * UPDATE UNSUBSCRIBE WARNING
     */
    function updateUnsubscribeWarning() {
      const warning = document.getElementById('unsubscribe-warning');
      warning.style.display = preferences.unsubscribeAll ? 'block' : 'none';
    }

    /**
     * SAVE PREFERENCES
     */
    async function savePreferences(event) {
      event.preventDefault();

      // Get quiet hours from inputs
      preferences.quietHours.startTime = document.getElementById('quiet-start').value;
      preferences.quietHours.endTime = document.getElementById('quiet-end').value;

      const saveBtn = document.getElementById('save-btn');
      saveBtn.disabled = true;
      saveBtn.textContent = 'Saving...';

      try {
        const response = await fetch('/api/user/preferences', {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
          },
          body: JSON.stringify({
            notifications: preferences
          })
        });

        if (response.ok) {
          // Show success message
          const successMessage = document.getElementById('success-message');
          successMessage.classList.add('show');
          setTimeout(() => {
            successMessage.classList.remove('show');
          }, 5000);
        } else {
          alert('Failed to save preferences');
        }
      } catch (error) {
        console.error('Failed to save preferences:', error);
        alert('Failed to save preferences');
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save Preferences';
      }
    }
  </script>

</body>
</html>
