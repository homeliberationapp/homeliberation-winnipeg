<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Velocity Real Estate</title>
  <style>
    /* PROFESSIONAL ADMIN UI - Clean, Modern, Functional */
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --navy: #0F172A;
      --amber: #F59E0B;
      --green: #10B981;
      --red: #EF4444;
      --bg: #F8FAFC;
      --card: #FFFFFF;
      --border: #E2E8F0;
      --text: #1E293B;
      --text-light: #64748B;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    /* TOP NAVBAR */
    .navbar {
      background: var(--navy);
      color: white;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .navbar h1 {
      font-size: 1.5rem;
      font-weight: 600;
    }

    .navbar-right {
      display: flex;
      gap: 2rem;
      align-items: center;
    }

    .nav-stat {
      text-align: center;
    }

    .nav-stat-value {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--amber);
    }

    .nav-stat-label {
      font-size: 0.75rem;
      opacity: 0.8;
    }

    /* STATS BAR */
    .stats-bar {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      padding: 2rem;
    }

    .stat-card {
      background: var(--card);
      padding: 1.5rem;
      border-radius: 8px;
      border-left: 4px solid var(--amber);
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .stat-card.green { border-left-color: var(--green); }
    .stat-card.red { border-left-color: var(--red); }

    .stat-label {
      font-size: 0.875rem;
      color: var(--text-light);
      margin-bottom: 0.5rem;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: bold;
      color: var(--text);
    }

    .stat-change {
      font-size: 0.875rem;
      margin-top: 0.5rem;
    }

    .stat-change.up { color: var(--green); }
    .stat-change.down { color: var(--red); }

    /* TABS */
    .tabs {
      display: flex;
      gap: 0;
      padding: 0 2rem;
      border-bottom: 2px solid var(--border);
      background: white;
    }

    .tab {
      padding: 1rem 2rem;
      cursor: pointer;
      border: none;
      background: none;
      font-size: 1rem;
      color: var(--text-light);
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
    }

    .tab:hover {
      color: var(--text);
      background: var(--bg);
    }

    .tab.active {
      color: var(--amber);
      border-bottom-color: var(--amber);
      font-weight: 600;
    }

    /* CONTENT AREA */
    .content {
      padding: 2rem;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* KANBAN BOARD (Leads Pipeline) */
    .kanban {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1rem;
      margin-top: 1rem;
    }

    .kanban-column {
      background: var(--card);
      border-radius: 8px;
      padding: 1rem;
      min-height: 400px;
    }

    .kanban-header {
      font-weight: 600;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid var(--border);
      display: flex;
      justify-content: space-between;
    }

    .kanban-count {
      background: var(--amber);
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.875rem;
    }

    .lead-card {
      background: var(--bg);
      padding: 1rem;
      border-radius: 6px;
      margin-bottom: 0.75rem;
      cursor: move;
      border-left: 3px solid var(--amber);
      transition: all 0.2s;
    }

    .lead-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      transform: translateY(-2px);
    }

    .lead-card.high-score {
      border-left-color: var(--green);
      background: #F0FDF4;
    }

    .lead-card.low-score {
      border-left-color: var(--red);
      opacity: 0.7;
    }

    .lead-address {
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .lead-score {
      display: inline-block;
      background: var(--amber);
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: bold;
    }

    .lead-score.high { background: var(--green); }
    .lead-score.low { background: var(--red); }

    .lead-meta {
      font-size: 0.875rem;
      color: var(--text-light);
      margin-top: 0.5rem;
    }

    .lead-actions {
      margin-top: 0.75rem;
      display: flex;
      gap: 0.5rem;
    }

    .btn {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.875rem;
      font-weight: 500;
      transition: all 0.2s;
    }

    .btn-primary {
      background: var(--amber);
      color: white;
    }

    .btn-primary:hover {
      background: #D97706;
    }

    .btn-success {
      background: var(--green);
      color: white;
    }

    .btn-danger {
      background: var(--red);
      color: white;
    }

    .btn-secondary {
      background: var(--border);
      color: var(--text);
    }

    .btn-small {
      padding: 0.25rem 0.5rem;
      font-size: 0.75rem;
    }

    /* DEALS TABLE */
    .deals-table {
      background: var(--card);
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th {
      background: var(--navy);
      color: white;
      padding: 1rem;
      text-align: left;
      font-weight: 600;
    }

    td {
      padding: 1rem;
      border-bottom: 1px solid var(--border);
    }

    tr:hover {
      background: var(--bg);
    }

    .badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .badge-active { background: #FEF3C7; color: #92400E; }
    .badge-assigned { background: #DBEAFE; color: #1E40AF; }
    .badge-closed { background: #D1FAE5; color: #065F46; }

    /* FINANCIAL DASHBOARD */
    .financial-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 2rem;
      margin-top: 1rem;
    }

    .chart-card {
      background: var(--card);
      padding: 1.5rem;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .chart-card h3 {
      margin-bottom: 1rem;
    }

    .tax-summary {
      background: #FEF3C7;
      padding: 1rem;
      border-radius: 6px;
      border-left: 4px solid var(--amber);
    }

    .tax-line {
      display: flex;
      justify-content: space-between;
      padding: 0.5rem 0;
      border-bottom: 1px solid rgba(0,0,0,0.1);
    }

    .tax-line.total {
      font-weight: bold;
      font-size: 1.25rem;
      border-top: 2px solid var(--text);
      border-bottom: none;
      margin-top: 0.5rem;
    }

    /* RESPONSIVE */
    @media (max-width: 1024px) {
      .kanban {
        grid-template-columns: 1fr 1fr;
      }

      .financial-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      .kanban {
        grid-template-columns: 1fr;
      }

      .stats-bar {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>

  <!-- NAVBAR -->
  <div class="navbar">
    <h1>‚ö° Velocity Real Estate - Admin</h1>
    <div class="navbar-right">
      <div class="nav-stat">
        <div class="nav-stat-value" id="todayRevenue">$0</div>
        <div class="nav-stat-label">Today's Revenue</div>
      </div>
      <div class="nav-stat">
        <div class="nav-stat-value" id="monthRevenue">$0</div>
        <div class="nav-stat-label">This Month</div>
      </div>
      <button class="btn btn-secondary btn-small" onclick="refreshData()">üîÑ Refresh</button>
    </div>
  </div>

  <!-- STATS BAR -->
  <div class="stats-bar">
    <div class="stat-card">
      <div class="stat-label">Total Leads</div>
      <div class="stat-value" id="totalLeads">0</div>
      <div class="stat-change up" id="leadsChange">+12 this week</div>
    </div>

    <div class="stat-card green">
      <div class="stat-label">High-Score Leads</div>
      <div class="stat-value" id="highScoreLeads">0</div>
      <div class="stat-change" id="highScoreChange">Call ASAP!</div>
    </div>

    <div class="stat-card">
      <div class="stat-label">Active Deals</div>
      <div class="stat-value" id="activeDeals">0</div>
      <div class="stat-change" id="dealsChange">3 pending bids</div>
    </div>

    <div class="stat-card green">
      <div class="stat-label">Closed Deals (MTD)</div>
      <div class="stat-value" id="closedDeals">0</div>
      <div class="stat-change up" id="closedChange">+2 vs last month</div>
    </div>

    <div class="stat-card">
      <div class="stat-label">Active Buyers</div>
      <div class="stat-value" id="activeBuyers">0</div>
      <div class="stat-change" id="buyersChange">47 paid subscribers</div>
    </div>

    <div class="stat-card green">
      <div class="stat-label">Net Cash (After Tax)</div>
      <div class="stat-value" id="netCash">$0</div>
      <div class="stat-change up" id="cashChange">+$15,662 this week</div>
    </div>
  </div>

  <!-- TABS -->
  <div class="tabs">
    <button class="tab active" onclick="switchTab('leads')">üìã Leads Pipeline</button>
    <button class="tab" onclick="switchTab('deals')">üè† Active Deals</button>
    <button class="tab" onclick="switchTab('held')">üîí Held Properties</button>
    <button class="tab" onclick="switchTab('buyers')">üë• Buyers</button>
    <button class="tab" onclick="switchTab('financial')">üí∞ Financial</button>
    <button class="tab" onclick="switchTab('settings')">‚öôÔ∏è Settings</button>
  </div>

  <!-- CONTENT -->
  <div class="content">

    <!-- LEADS PIPELINE TAB -->
    <div class="tab-content active" id="leads-tab">
      <h2>Leads Pipeline (Kanban)</h2>
      <div class="kanban">

        <!-- COLUMN 1: NEW LEADS -->
        <div class="kanban-column">
          <div class="kanban-header">
            <span>üÜï New Leads</span>
            <span class="kanban-count" id="newCount">0</span>
          </div>
          <div id="newLeads">
            <!-- Lead cards populated by JS -->
          </div>
        </div>

        <!-- COLUMN 2: OFFER SENT -->
        <div class="kanban-column">
          <div class="kanban-header">
            <span>üìß Offer Sent</span>
            <span class="kanban-count" id="offerSentCount">0</span>
          </div>
          <div id="offerSentLeads">
            <!-- Lead cards -->
          </div>
        </div>

        <!-- COLUMN 3: NEGOTIATING -->
        <div class="kanban-column">
          <div class="kanban-header">
            <span>ü§ù Negotiating</span>
            <span class="kanban-count" id="negotiatingCount">0</span>
          </div>
          <div id="negotiatingLeads">
            <!-- Lead cards -->
          </div>
        </div>

        <!-- COLUMN 4: SIGNED -->
        <div class="kanban-column">
          <div class="kanban-header">
            <span>‚úÖ Signed</span>
            <span class="kanban-count" id="signedCount">0</span>
          </div>
          <div id="signedLeads">
            <!-- Lead cards -->
          </div>
        </div>

      </div>
    </div>

    <!-- HELD PROPERTIES TAB -->
    <div class="tab-content" id="held-tab">
      <h2>Held Properties (Admin Review)</h2>

      <!-- Auto-Hold Rules Panel -->
      <div class="chart-card" style="margin-bottom: 2rem; background: #FEF3C7;">
        <h3>‚öôÔ∏è Auto-Hold Rules (Properties matching these criteria are auto-held for admin review)</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
          <div>
            <label>Min Profit Margin (%)</label>
            <input type="number" id="minProfitMargin" placeholder="15" style="width: 100%; padding: 0.5rem;" />
          </div>
          <div>
            <label>Min Deal Quality Score</label>
            <input type="number" id="minDealQuality" placeholder="75" style="width: 100%; padding: 0.5rem;" />
          </div>
          <div>
            <label>Property Types (comma-separated)</label>
            <input type="text" id="propertyTypes" placeholder="multi-family,apartment" style="width: 100%; padding: 0.5rem;" />
          </div>
          <div>
            <label>Min Units (Multi-Family)</label>
            <input type="number" id="minUnits" placeholder="5" style="width: 100%; padding: 0.5rem;" />
          </div>
          <div>
            <label>Postal Codes (comma-separated)</label>
            <input type="text" id="postalCodes" placeholder="R3T,R3C" style="width: 100%; padding: 0.5rem;" />
          </div>
          <div>
            <label>Min ARV ($)</label>
            <input type="number" id="minARV" placeholder="500000" style="width: 100%; padding: 0.5rem;" />
          </div>
        </div>
        <button class="btn btn-primary" style="margin-top: 1rem;" onclick="saveAutoHoldRules()">
          üíæ Save Auto-Hold Rules
        </button>
      </div>

      <!-- Held Properties Table -->
      <div class="deals-table">
        <table>
          <thead>
            <tr>
              <th>Address</th>
              <th>ARV</th>
              <th>Our Offer</th>
              <th>Profit Margin</th>
              <th>Hold Reason</th>
              <th>Expires</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="heldPropertiesBody">
            <!-- Populated by JS -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- ACTIVE DEALS TAB -->
    <div class="tab-content" id="deals-tab">
      <h2>Active Deals</h2>
      <div class="deals-table">
        <table>
          <thead>
            <tr>
              <th>Address</th>
              <th>Seller</th>
              <th>ARV</th>
              <th>Our Offer</th>
              <th>Assignment Fee</th>
              <th>Bids</th>
              <th>Highest Bid</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="dealsTableBody">
            <!-- Populated by JS -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- BUYERS TAB -->
    <div class="tab-content" id="buyers-tab">
      <h2>Buyer Database</h2>
      <div class="deals-table">
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>Tier</th>
              <th>Bids Placed</th>
              <th>Deals Won</th>
              <th>Total Spent</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="buyersTableBody">
            <!-- Populated by JS -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- FINANCIAL TAB -->
    <div class="tab-content" id="financial-tab">
      <h2>Financial Dashboard</h2>

      <div class="financial-grid">

        <!-- LEFT: REVENUE CHART -->
        <div class="chart-card">
          <h3>Monthly Revenue</h3>
          <canvas id="revenueChart" width="400" height="200"></canvas>
        </div>

        <!-- RIGHT: TAX SUMMARY -->
        <div class="chart-card">
          <h3>This Month - Tax Breakdown</h3>
          <div class="tax-summary">
            <div class="tax-line">
              <span>Assignment Fees:</span>
              <span id="taxGross">$40,000</span>
            </div>
            <div class="tax-line">
              <span>+ HST Collected (5%):</span>
              <span id="taxHST">$2,000</span>
            </div>
            <div class="tax-line">
              <span>= Gross Income:</span>
              <span id="taxTotalGross">$42,000</span>
            </div>
            <div class="tax-line">
              <span>- Expenses:</span>
              <span id="taxExpenses">$625</span>
            </div>
            <div class="tax-line">
              <span>= Net Income:</span>
              <span id="taxNetIncome">$41,375</span>
            </div>
            <div class="tax-line">
              <span>- Income Tax (25.8%):</span>
              <span id="taxIncomeTax">$10,675</span>
            </div>
            <div class="tax-line total">
              <span>NET CASH (What You Keep):</span>
              <span id="taxNetCash" style="color: var(--green);">$31,325</span>
            </div>
          </div>

          <button class="btn btn-primary" style="margin-top: 1rem; width: 100%;" onclick="downloadTaxReport()">
            üì• Download Tax Report (CSV)
          </button>
        </div>

      </div>

      <!-- QUARTERLY TAX REMINDER -->
      <div class="chart-card" style="margin-top: 2rem; background: #FEF3C7;">
        <h3>‚ö†Ô∏è Quarterly Tax Payment Due</h3>
        <p>Q4 2025 tax payment due: <strong>January 15, 2026</strong></p>
        <p>Estimated payment: <strong>$12,750</strong> (HST + Income Tax)</p>
        <button class="btn btn-primary">Set Reminder</button>
      </div>

    </div>

    <!-- SETTINGS TAB -->
    <div class="tab-content" id="settings-tab">
      <h2>Settings</h2>
      <div class="chart-card">
        <h3>Brand Settings</h3>
        <p>Phone: <input type="text" value="204-VEL-FAST" /></p>
        <p>Email: <input type="email" value="offers@velocityrealestate.ca" /></p>
        <button class="btn btn-primary">Save Changes</button>
      </div>

      <div class="chart-card" style="margin-top: 1rem;">
        <h3>API Keys</h3>
        <p>Google Maps: <input type="password" value="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" /></p>
        <p>Twilio: <input type="password" value="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" /></p>
        <button class="btn btn-primary">Update Keys</button>
      </div>
    </div>

  </div>

  <script>
    // TAB SWITCHING
    function switchTab(tabName) {
      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));

      // Show selected tab
      document.getElementById(tabName + '-tab').classList.add('active');
      event.target.classList.add('active');
    }

    // LOAD DATA FROM GOOGLE SHEETS API
    async function loadDashboardData() {
      try {
        // Fetch from your backend API
        const response = await fetch('/api/admin/dashboard');
        const data = await response.json();

        // Update stats
        document.getElementById('totalLeads').textContent = data.totalLeads;
        document.getElementById('highScoreLeads').textContent = data.highScoreLeads;
        document.getElementById('activeDeals').textContent = data.activeDeals;
        document.getElementById('closedDeals').textContent = data.closedDeals;
        document.getElementById('activeBuyers').textContent = data.activeBuyers;
        document.getElementById('netCash').textContent = '$' + data.netCash.toLocaleString();

        // Populate Kanban
        populateKanban(data.leads);

        // Populate Deals Table
        populateDealsTable(data.deals);

        // Populate Buyers Table
        populateBuyersTable(data.buyers);

        // Update Financial
        updateFinancialDashboard(data.financial);

      } catch (error) {
        console.error('Error loading dashboard:', error);
      }
    }

    // POPULATE KANBAN
    function populateKanban(leads) {
      const columns = {
        new: document.getElementById('newLeads'),
        offer_sent: document.getElementById('offerSentLeads'),
        negotiating: document.getElementById('negotiatingLeads'),
        signed: document.getElementById('signedLeads')
      };

      // Clear existing
      Object.values(columns).forEach(col => col.innerHTML = '');

      // Sort leads into columns
      leads.forEach(lead => {
        const card = createLeadCard(lead);
        columns[lead.status]?.appendChild(card);
      });

      // Update counts
      document.getElementById('newCount').textContent = document.getElementById('newLeads').children.length;
      document.getElementById('offerSentCount').textContent = document.getElementById('offerSentLeads').children.length;
      document.getElementById('negotiatingCount').textContent = document.getElementById('negotiatingLeads').children.length;
      document.getElementById('signedCount').textContent = document.getElementById('signedLeads').children.length;
    }

    // CREATE LEAD CARD
    function createLeadCard(lead) {
      const card = document.createElement('div');
      card.className = 'lead-card';
      if (lead.leadScore >= 70) card.classList.add('high-score');
      if (lead.leadScore < 40) card.classList.add('low-score');

      card.innerHTML = `
        <div class="lead-address">${lead.address}</div>
        <span class="lead-score ${lead.leadScore >= 70 ? 'high' : lead.leadScore >= 40 ? '' : 'low'}">
          Score: ${lead.leadScore}
        </span>
        <div class="lead-meta">
          üìû ${lead.phone}<br>
          üí∞ Offer: $${lead.offer?.toLocaleString() || 'Calculating...'}<br>
          ‚è∞ ${lead.urgency}
        </div>
        <div class="lead-actions">
          <button class="btn btn-primary btn-small" onclick="callLead('${lead.id}')">üìû Call</button>
          <button class="btn btn-success btn-small" onclick="sendOffer('${lead.id}')">üìß Send Offer</button>
          <button class="btn btn-secondary btn-small" onclick="viewLead('${lead.id}')">üëÅÔ∏è View</button>
          <button class="btn btn-danger btn-small" onclick="holdProperty('${lead.id}')">üîí Hold</button>
          <button class="btn btn-success btn-small" onclick="selfPurchase('${lead.id}')">üè† Self-Buy</button>
        </div>
      `;

      return card;
    }

    // POPULATE DEALS TABLE
    function populateDealsTable(deals) {
      const tbody = document.getElementById('dealsTableBody');
      tbody.innerHTML = deals.map(deal => `
        <tr>
          <td>${deal.address}</td>
          <td>${deal.sellerName}</td>
          <td>$${deal.arv.toLocaleString()}</td>
          <td>$${deal.offer.toLocaleString()}</td>
          <td>$${deal.assignmentFee.toLocaleString()}</td>
          <td>${deal.bidCount || 0}</td>
          <td>$${deal.highestBid?.toLocaleString() || '-'}</td>
          <td><span class="badge badge-${deal.status}">${deal.status}</span></td>
          <td>
            <button class="btn btn-primary btn-small" onclick="viewDeal('${deal.id}')">View</button>
          </td>
        </tr>
      `).join('');
    }

    // POPULATE BUYERS TABLE
    function populateBuyersTable(buyers) {
      const tbody = document.getElementById('buyersTableBody');
      tbody.innerHTML = buyers.map(buyer => `
        <tr>
          <td>${buyer.name}</td>
          <td>${buyer.email}</td>
          <td><span class="badge badge-${buyer.tier}">${buyer.tier}</span></td>
          <td>${buyer.bidsPlaced}</td>
          <td>${buyer.dealsWon}</td>
          <td>$${buyer.totalSpent.toLocaleString()}</td>
          <td><span class="badge badge-${buyer.status === 'active' ? 'active' : 'inactive'}">${buyer.status}</span></td>
          <td>
            <button class="btn btn-secondary btn-small" onclick="viewBuyer('${buyer.id}')">View</button>
          </td>
        </tr>
      `).join('');
    }

    // UPDATE FINANCIAL DASHBOARD
    function updateFinancialDashboard(financial) {
      document.getElementById('taxGross').textContent = '$' + financial.grossRevenue.toLocaleString();
      document.getElementById('taxHST').textContent = '$' + financial.hstCollected.toLocaleString();
      document.getElementById('taxTotalGross').textContent = '$' + (financial.grossRevenue + financial.hstCollected).toLocaleString();
      document.getElementById('taxExpenses').textContent = '$' + financial.expenses.toLocaleString();
      document.getElementById('taxNetIncome').textContent = '$' + financial.netIncome.toLocaleString();
      document.getElementById('taxIncomeTax').textContent = '$' + financial.incomeTax.toLocaleString();
      document.getElementById('taxNetCash').textContent = '$' + financial.netCash.toLocaleString();
    }

    // ACTIONS
    async function callLead(leadId) {
      alert('Calling lead: ' + leadId);
      // Could integrate with Twilio click-to-call
    }

    async function sendOffer(leadId) {
      if (confirm('Send offer email to this lead?')) {
        await fetch('/api/send-offer', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ leadId })
        });
        alert('Offer sent!');
        refreshData();
      }
    }

    async function viewLead(leadId) {
      window.open('/admin/lead/' + leadId, '_blank');
    }

    async function viewDeal(dealId) {
      window.open('/deals/' + dealId, '_blank');
    }

    async function viewBuyer(buyerId) {
      window.open('/admin/buyer/' + buyerId, '_blank');
    }

    async function downloadTaxReport() {
      window.location.href = '/api/admin/tax-report.csv';
    }

    async function refreshData() {
      loadDashboardData();
      loadHeldProperties();
    }

    // ADMIN HOLD FUNCTIONS
    async function holdProperty(leadId) {
      const reason = prompt('Why are you holding this property?\n(e.g., "Reviewing for self-purchase", "High margin deal")');
      if (!reason) return;

      try {
        const response = await fetch('/api/admin/hold-property', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ propertyId: leadId, reason })
        });

        if (response.ok) {
          alert('‚úÖ Property held successfully! Will auto-release in 48 hours.');
          refreshData();
        }
      } catch (error) {
        console.error('Error holding property:', error);
        alert('‚ùå Failed to hold property');
      }
    }

    async function selfPurchase(leadId) {
      const confirm = window.confirm('Are you sure you want to purchase this property yourself?\n\nThis will remove it from the buyer pool permanently.');
      if (!confirm) return;

      const notes = prompt('Notes about this purchase:');

      try {
        const response = await fetch('/api/admin/self-purchase', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ propertyId: leadId, notes })
        });

        if (response.ok) {
          alert('‚úÖ Property marked for self-purchase! Moved to your personal portfolio.');
          refreshData();
        }
      } catch (error) {
        console.error('Error marking self-purchase:', error);
        alert('‚ùå Failed to mark for self-purchase');
      }
    }

    async function releaseProperty(propertyId) {
      const confirm = window.confirm('Release this property to buyers?');
      if (!confirm) return;

      try {
        const response = await fetch('/api/admin/release-property', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ propertyId })
        });

        if (response.ok) {
          alert('‚úÖ Property released to buyers! Matching buyers will be notified.');
          refreshData();
        }
      } catch (error) {
        console.error('Error releasing property:', error);
        alert('‚ùå Failed to release property');
      }
    }

    async function extendHold(propertyId) {
      const hours = prompt('Extend hold by how many hours?', '24');
      if (!hours) return;

      try {
        const response = await fetch('/api/admin/extend-hold', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ propertyId, additionalHours: parseInt(hours) })
        });

        if (response.ok) {
          alert(`‚úÖ Hold extended by ${hours} hours`);
          refreshData();
        }
      } catch (error) {
        console.error('Error extending hold:', error);
        alert('‚ùå Failed to extend hold');
      }
    }

    async function loadHeldProperties() {
      try {
        const response = await fetch('/api/admin/held-properties');
        const properties = await response.json();

        const tbody = document.getElementById('heldPropertiesBody');
        if (!tbody) return; // Tab not loaded yet

        tbody.innerHTML = properties.map(prop => {
          const expiryDate = prop.holdUntil ? new Date(prop.holdUntil) : null;
          const isExpiringSoon = expiryDate && (expiryDate - Date.now()) < (6 * 60 * 60 * 1000); // < 6 hours

          return `
            <tr style="${isExpiringSoon ? 'background: #FEE2E2;' : ''}">
              <td>${prop.address}</td>
              <td>$${prop.arv?.toLocaleString() || '-'}</td>
              <td>$${prop.offer?.toLocaleString() || '-'}</td>
              <td style="color: ${prop.profitMargin > 0.15 ? 'var(--green)' : 'var(--text)'};">
                ${((prop.profitMargin || 0) * 100).toFixed(1)}%
              </td>
              <td style="font-size: 0.875rem;">${prop.holdReason || '-'}</td>
              <td style="font-size: 0.875rem; ${isExpiringSoon ? 'color: var(--red); font-weight: bold;' : ''}">
                ${expiryDate ? expiryDate.toLocaleString() : 'No expiry'}
              </td>
              <td>
                <span class="badge badge-${prop.adminHoldStatus === 'HOLD' ? 'active' : 'assigned'}">
                  ${prop.adminHoldStatus}
                </span>
              </td>
              <td>
                ${prop.adminHoldStatus === 'HOLD' ? `
                  <button class="btn btn-success btn-small" onclick="releaseProperty('${prop.id}')">üöÄ Release</button>
                  <button class="btn btn-secondary btn-small" onclick="extendHold('${prop.id}')">‚è∞ Extend</button>
                  <button class="btn btn-primary btn-small" onclick="selfPurchase('${prop.id}')">üè† Buy</button>
                ` : `
                  <button class="btn btn-secondary btn-small" onclick="viewLead('${prop.id}')">üëÅÔ∏è View</button>
                `}
              </td>
            </tr>
          `;
        }).join('');

        // Load auto-hold rules into form
        loadAutoHoldRulesForm();

      } catch (error) {
        console.error('Error loading held properties:', error);
      }
    }

    async function saveAutoHoldRules() {
      const rules = {
        minProfitMargin: parseFloat(document.getElementById('minProfitMargin').value) / 100 || null,
        minDealQuality: parseInt(document.getElementById('minDealQuality').value) || null,
        propertyTypes: document.getElementById('propertyTypes').value.split(',').map(t => t.trim()).filter(Boolean),
        minUnits: parseInt(document.getElementById('minUnits').value) || null,
        postalCodes: document.getElementById('postalCodes').value.split(',').map(t => t.trim()).filter(Boolean),
        minARV: parseInt(document.getElementById('minARV').value) || null,
        enabled: true
      };

      try {
        const response = await fetch('/api/admin/save-hold-rules', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ rules })
        });

        if (response.ok) {
          alert('‚úÖ Auto-hold rules saved!\n\nNew properties matching these criteria will be auto-held for your review.');
        }
      } catch (error) {
        console.error('Error saving rules:', error);
        alert('‚ùå Failed to save rules');
      }
    }

    async function loadAutoHoldRulesForm() {
      try {
        const response = await fetch('/api/admin/get-hold-rules');
        const rules = await response.json();

        if (rules && document.getElementById('minProfitMargin')) {
          document.getElementById('minProfitMargin').value = rules.minProfitMargin ? (rules.minProfitMargin * 100) : '';
          document.getElementById('minDealQuality').value = rules.minDealQuality || '';
          document.getElementById('propertyTypes').value = rules.propertyTypes ? rules.propertyTypes.join(', ') : '';
          document.getElementById('minUnits').value = rules.minUnits || '';
          document.getElementById('postalCodes').value = rules.postalCodes ? rules.postalCodes.join(', ') : '';
          document.getElementById('minARV').value = rules.minARV || '';
        }
      } catch (error) {
        console.error('Error loading rules:', error);
      }
    }

    async function refreshData() {
      loadDashboardData();
      loadHeldProperties();
    }

    // LOAD ON PAGE LOAD
    document.addEventListener('DOMContentLoaded', () => {
      loadDashboardData();
      loadHeldProperties();

      // Auto-refresh every 30 seconds
      setInterval(refreshData, 30000);
    });
  </script>

  <!-- ADMIN HOLD SYSTEM SCRIPT -->
  <script src="../bots/admin_hold_system.js"></script>

</body>
</html>
