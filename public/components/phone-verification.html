<!DOCTYPE html>
<!--
  PHONE VERIFICATION COMPONENT
  Reusable SMS verification component

  Usage:
  <script src="/components/phone-verification.html"></script>
  PhoneVerification.init('#verification-container', callback);
-->

<style>
  .phone-verification {
    max-width: 400px;
    margin: 0 auto;
  }

  .verification-step {
    display: none;
  }

  .verification-step.active {
    display: block;
  }

  .phone-input-group {
    margin-bottom: 20px;
  }

  .phone-label {
    display: block;
    font-weight: 600;
    color: #1E293B;
    margin-bottom: 8px;
  }

  .phone-input {
    width: 100%;
    padding: 14px;
    border: 2px solid #E2E8F0;
    border-radius: 8px;
    font-size: 16px;
    transition: border-color 0.2s ease;
  }

  .phone-input:focus {
    outline: none;
    border-color: #F59E0B;
  }

  .phone-input.error {
    border-color: #EF4444;
  }

  .phone-hint {
    font-size: 12px;
    color: #64748B;
    margin-top: 4px;
  }

  .code-input-container {
    display: flex;
    gap: 12px;
    justify-content: center;
    margin: 30px 0;
  }

  .code-digit {
    width: 50px;
    height: 60px;
    text-align: center;
    font-size: 24px;
    font-weight: 700;
    border: 2px solid #E2E8F0;
    border-radius: 8px;
    transition: border-color 0.2s ease;
  }

  .code-digit:focus {
    outline: none;
    border-color: #F59E0B;
  }

  .code-digit.error {
    border-color: #EF4444;
    animation: shake 0.3s;
  }

  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
  }

  .btn-verify {
    width: 100%;
    padding: 14px;
    background: linear-gradient(135deg, #F59E0B 0%, #F97316 100%);
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    font-size: 16px;
    cursor: pointer;
    transition: transform 0.2s ease;
  }

  .btn-verify:hover:not(:disabled) {
    transform: translateY(-2px);
  }

  .btn-verify:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .verification-message {
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 16px;
    display: none;
    align-items: center;
    gap: 8px;
  }

  .verification-message.show {
    display: flex;
  }

  .message-error {
    background: #FEE2E2;
    color: #DC2626;
  }

  .message-success {
    background: #D1FAE5;
    color: #059669;
  }

  .message-info {
    background: #DBEAFE;
    color: #1D4ED8;
  }

  .verification-status {
    text-align: center;
    margin-bottom: 20px;
  }

  .status-title {
    font-size: 18px;
    font-weight: 600;
    color: #1E293B;
    margin-bottom: 8px;
  }

  .status-subtitle {
    font-size: 14px;
    color: #64748B;
  }

  .status-phone {
    font-weight: 600;
    color: #F59E0B;
  }

  .resend-link {
    text-align: center;
    margin-top: 20px;
  }

  .resend-button {
    background: none;
    border: none;
    color: #F59E0B;
    text-decoration: underline;
    cursor: pointer;
    font-size: 14px;
  }

  .resend-button:disabled {
    color: #94A3B8;
    cursor: not-allowed;
  }

  .timer {
    font-size: 14px;
    color: #64748B;
    margin-top: 8px;
  }

  .success-icon {
    font-size: 64px;
    margin-bottom: 16px;
  }
</style>

<script>
class PhoneVerification {

  constructor(container, onVerified) {
    this.container = typeof container === 'string' ? document.querySelector(container) : container;
    this.onVerified = onVerified || (() => {});
    this.currentStep = 'phone'; // 'phone', 'code', 'success'
    this.phoneNumber = '';
    this.resendTimer = null;
    this.resendCountdown = 60;

    this.render();
    this.attachEvents();
  }

  /**
   * RENDER COMPONENT
   */
  render() {
    this.container.innerHTML = `
      <div class="phone-verification">
        <!-- Messages -->
        <div class="verification-message message-error" id="error-message"></div>
        <div class="verification-message message-success" id="success-message"></div>
        <div class="verification-message message-info" id="info-message"></div>

        <!-- Step 1: Enter Phone Number -->
        <div class="verification-step active" id="step-phone">
          <div class="verification-status">
            <div class="status-title">Verify Your Phone Number</div>
            <div class="status-subtitle">We'll send you a 6-digit code via SMS</div>
          </div>

          <div class="phone-input-group">
            <label class="phone-label">Phone Number</label>
            <input
              type="tel"
              class="phone-input"
              id="phone-input"
              placeholder="(204) 555-1234"
              maxlength="14"
            />
            <div class="phone-hint">Enter your Canadian phone number</div>
          </div>

          <button class="btn-verify" id="send-code-btn">Send Verification Code</button>
        </div>

        <!-- Step 2: Enter Verification Code -->
        <div class="verification-step" id="step-code">
          <div class="verification-status">
            <div class="status-title">Enter Verification Code</div>
            <div class="status-subtitle">
              We sent a 6-digit code to<br/>
              <span class="status-phone" id="display-phone"></span>
            </div>
          </div>

          <div class="code-input-container">
            <input type="text" class="code-digit" maxlength="1" data-index="0" />
            <input type="text" class="code-digit" maxlength="1" data-index="1" />
            <input type="text" class="code-digit" maxlength="1" data-index="2" />
            <input type="text" class="code-digit" maxlength="1" data-index="3" />
            <input type="text" class="code-digit" maxlength="1" data-index="4" />
            <input type="text" class="code-digit" maxlength="1" data-index="5" />
          </div>

          <button class="btn-verify" id="verify-code-btn">Verify Code</button>

          <div class="resend-link">
            <button class="resend-button" id="resend-btn" disabled>Resend Code</button>
            <div class="timer" id="resend-timer">Resend available in <span id="countdown">60</span>s</div>
          </div>
        </div>

        <!-- Step 3: Success -->
        <div class="verification-step" id="step-success">
          <div class="verification-status">
            <div class="success-icon">âœ…</div>
            <div class="status-title">Phone Verified!</div>
            <div class="status-subtitle">Your phone number has been successfully verified</div>
          </div>
        </div>
      </div>
    `;
  }

  /**
   * ATTACH EVENTS
   */
  attachEvents() {
    // Phone input formatting
    const phoneInput = this.container.querySelector('#phone-input');
    phoneInput.addEventListener('input', (e) => {
      this.formatPhoneInput(e.target);
    });

    // Send code button
    const sendBtn = this.container.querySelector('#send-code-btn');
    sendBtn.addEventListener('click', () => this.sendCode());

    // Code digit inputs
    const codeDigits = this.container.querySelectorAll('.code-digit');
    codeDigits.forEach((digit, index) => {
      // Auto-focus next digit
      digit.addEventListener('input', (e) => {
        if (e.target.value.length === 1 && index < 5) {
          codeDigits[index + 1].focus();
        }

        // Auto-verify when all digits entered
        if (index === 5 && e.target.value.length === 1) {
          this.verifyCode();
        }
      });

      // Backspace to previous digit
      digit.addEventListener('keydown', (e) => {
        if (e.key === 'Backspace' && e.target.value === '' && index > 0) {
          codeDigits[index - 1].focus();
        }
      });

      // Only allow digits
      digit.addEventListener('input', (e) => {
        e.target.value = e.target.value.replace(/[^0-9]/g, '');
      });
    });

    // Verify code button
    const verifyBtn = this.container.querySelector('#verify-code-btn');
    verifyBtn.addEventListener('click', () => this.verifyCode());

    // Resend button
    const resendBtn = this.container.querySelector('#resend-btn');
    resendBtn.addEventListener('click', () => this.resendCode());
  }

  /**
   * FORMAT PHONE INPUT
   * Format as (XXX) XXX-XXXX
   */
  formatPhoneInput(input) {
    let value = input.value.replace(/\D/g, '');
    let formatted = '';

    if (value.length > 0) {
      formatted = '(' + value.substring(0, 3);
    }
    if (value.length >= 4) {
      formatted += ') ' + value.substring(3, 6);
    }
    if (value.length >= 7) {
      formatted += '-' + value.substring(6, 10);
    }

    input.value = formatted;
  }

  /**
   * SEND CODE
   */
  async sendCode() {
    const phoneInput = this.container.querySelector('#phone-input');
    const sendBtn = this.container.querySelector('#send-code-btn');

    // Get phone number (remove formatting)
    const phoneNumber = phoneInput.value.replace(/\D/g, '');

    if (phoneNumber.length !== 10) {
      this.showError('Please enter a valid 10-digit phone number');
      phoneInput.classList.add('error');
      return;
    }

    phoneInput.classList.remove('error');
    sendBtn.disabled = true;
    sendBtn.textContent = 'Sending...';

    try {
      const response = await fetch('/api/phone/send-code', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${localStorage.getItem('authToken')}`
        },
        body: JSON.stringify({
          phoneNumber: phoneNumber
        })
      });

      const data = await response.json();

      if (response.ok) {
        this.phoneNumber = this.formatPhoneDisplay(phoneNumber);
        this.goToStep('code');
        this.startResendTimer();
        this.showInfo('Verification code sent via SMS');
      } else {
        this.showError(data.error || 'Failed to send code');
      }

    } catch (error) {
      console.error('Send code error:', error);
      this.showError('Failed to send code. Please try again.');
    } finally {
      sendBtn.disabled = false;
      sendBtn.textContent = 'Send Verification Code';
    }
  }

  /**
   * VERIFY CODE
   */
  async verifyCode() {
    const codeDigits = this.container.querySelectorAll('.code-digit');
    const code = Array.from(codeDigits).map(d => d.value).join('');

    if (code.length !== 6) {
      this.showError('Please enter the complete 6-digit code');
      codeDigits.forEach(d => d.classList.add('error'));
      setTimeout(() => {
        codeDigits.forEach(d => d.classList.remove('error'));
      }, 300);
      return;
    }

    const verifyBtn = this.container.querySelector('#verify-code-btn');
    verifyBtn.disabled = true;
    verifyBtn.textContent = 'Verifying...';

    try {
      const response = await fetch('/api/phone/verify-code', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${localStorage.getItem('authToken')}`
        },
        body: JSON.stringify({
          code: code
        })
      });

      const data = await response.json();

      if (response.ok) {
        this.goToStep('success');
        this.clearResendTimer();

        // Update user object
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        user.phoneVerified = true;
        user.phone = data.phoneNumber;
        localStorage.setItem('user', JSON.stringify(user));

        // Callback
        setTimeout(() => {
          this.onVerified(data.phoneNumber);
        }, 2000);

      } else {
        this.showError(data.error || 'Invalid code');
        codeDigits.forEach(d => {
          d.classList.add('error');
          d.value = '';
        });
        setTimeout(() => {
          codeDigits.forEach(d => d.classList.remove('error'));
          codeDigits[0].focus();
        }, 300);
      }

    } catch (error) {
      console.error('Verify code error:', error);
      this.showError('Failed to verify code. Please try again.');
    } finally {
      verifyBtn.disabled = false;
      verifyBtn.textContent = 'Verify Code';
    }
  }

  /**
   * RESEND CODE
   */
  async resendCode() {
    const resendBtn = this.container.querySelector('#resend-btn');
    resendBtn.disabled = true;
    resendBtn.textContent = 'Sending...';

    try {
      const response = await fetch('/api/phone/resend-code', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${localStorage.getItem('authToken')}`
        }
      });

      const data = await response.json();

      if (response.ok) {
        this.showInfo('Verification code resent via SMS');
        this.startResendTimer();

        // Clear code inputs
        const codeDigits = this.container.querySelectorAll('.code-digit');
        codeDigits.forEach(d => d.value = '');
        codeDigits[0].focus();
      } else {
        this.showError(data.error || 'Failed to resend code');
      }

    } catch (error) {
      console.error('Resend code error:', error);
      this.showError('Failed to resend code. Please try again.');
    } finally {
      resendBtn.textContent = 'Resend Code';
    }
  }

  /**
   * GO TO STEP
   */
  goToStep(step) {
    this.currentStep = step;

    const steps = this.container.querySelectorAll('.verification-step');
    steps.forEach(s => s.classList.remove('active'));

    const activeStep = this.container.querySelector(`#step-${step}`);
    activeStep.classList.add('active');

    if (step === 'code') {
      const displayPhone = this.container.querySelector('#display-phone');
      displayPhone.textContent = this.phoneNumber;

      // Focus first digit
      setTimeout(() => {
        const firstDigit = this.container.querySelector('.code-digit');
        firstDigit.focus();
      }, 100);
    }
  }

  /**
   * START RESEND TIMER
   */
  startResendTimer() {
    this.clearResendTimer();
    this.resendCountdown = 60;

    const resendBtn = this.container.querySelector('#resend-btn');
    const timerDiv = this.container.querySelector('#resend-timer');
    const countdownSpan = this.container.querySelector('#countdown');

    resendBtn.disabled = true;
    timerDiv.style.display = 'block';

    this.resendTimer = setInterval(() => {
      this.resendCountdown--;
      countdownSpan.textContent = this.resendCountdown;

      if (this.resendCountdown <= 0) {
        this.clearResendTimer();
        resendBtn.disabled = false;
        timerDiv.style.display = 'none';
      }
    }, 1000);
  }

  /**
   * CLEAR RESEND TIMER
   */
  clearResendTimer() {
    if (this.resendTimer) {
      clearInterval(this.resendTimer);
      this.resendTimer = null;
    }
  }

  /**
   * FORMAT PHONE DISPLAY
   */
  formatPhoneDisplay(phoneNumber) {
    return `(${phoneNumber.substring(0, 3)}) ${phoneNumber.substring(3, 6)}-${phoneNumber.substring(6, 10)}`;
  }

  /**
   * SHOW ERROR
   */
  showError(message) {
    this.hideAllMessages();
    const errorMsg = this.container.querySelector('#error-message');
    errorMsg.textContent = message;
    errorMsg.classList.add('show');
  }

  /**
   * SHOW SUCCESS
   */
  showSuccess(message) {
    this.hideAllMessages();
    const successMsg = this.container.querySelector('#success-message');
    successMsg.textContent = message;
    successMsg.classList.add('show');
  }

  /**
   * SHOW INFO
   */
  showInfo(message) {
    this.hideAllMessages();
    const infoMsg = this.container.querySelector('#info-message');
    infoMsg.textContent = message;
    infoMsg.classList.add('show');
  }

  /**
   * HIDE ALL MESSAGES
   */
  hideAllMessages() {
    const messages = this.container.querySelectorAll('.verification-message');
    messages.forEach(m => m.classList.remove('show'));
  }

  /**
   * STATIC INIT
   */
  static init(container, onVerified) {
    return new PhoneVerification(container, onVerified);
  }
}

// Export globally
window.PhoneVerification = PhoneVerification;
</script>
